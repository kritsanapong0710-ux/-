<!DOCTYPE html><html lang="th">
<head>
    <meta charset="UTF-8">
    <title>LOMNUER: Interactive Story - Full Version (Fixed & Extended)</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@200;300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #ff2d55; --line-blue: #3b5998; --line-green: #2ecc71; --font-main: 'Prompt', sans-serif; }
        * { font-family: var(--font-main); box-sizing: border-box; outline: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; color: white; overflow: hidden; }#fadeLayer { position: fixed; inset: 0; background: #000; z-index: 9999; pointer-events: none; opacity: 0; transition: opacity 0.6s; }
    .screen { position: absolute; inset: 0; display: none; background-size: cover; background-position: center; flex-direction: column; }
    .active { display: flex !important; }

    /* Timeline (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á original ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡πÜ) */
    #timeline { position: fixed; top: 18px; left: 50%; transform: translateX(-50%); z-index: 120; display:flex; gap:12px; align-items:center; }
    .tl-step { background: rgba(255,255,255,0.06); padding:8px 12px; border-radius:20px; min-width:110px; text-align:center; font-weight:600; letter-spacing:1px; color:#ddd; }
    .tl-step.active { background: linear-gradient(90deg, rgba(255,45,85,0.16), rgba(59,89,152,0.08)); color: #fff; box-shadow: 0 6px 20px rgba(0,0,0,0.6); }

    /* Status UI (‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤ Map) */
    #globalStatus { position: absolute; top: 70px; left: 40px; display: none; align-items: center; gap: 15px; z-index: 100; }
    .day-box { background: var(--primary); padding: 5px 15px; font-weight: 600; letter-spacing: 2px; border-radius: 4px; }

    /* Lobby */
    #lobby { background-image: url('‡∏†‡∏≤‡∏û‡∏´‡∏ô‡πâ‡∏≤lobby.jpg'); justify-content: center; align-items: center; }
    .play-btn { width: 130px; height: 130px; border-radius: 50%; border: 2px solid #fff; background: rgba(255,255,255,0.06); color: #fff; cursor: pointer; backdrop-filter: blur(6px); transition: 0.4s; font-size: 1.2rem; }
    .play-btn:hover { background: #fff; color: #000; transform: scale(1.05); }

    /* Map */
    #map-screen { background-image: url('map.jpg'); justify-content:flex-start; }
    .map-marker { position: absolute; width: 55px; height: 55px; background: var(--primary); border: 4px solid white; border-radius: 50%; cursor: pointer; box-shadow: 0 0 30px var(--primary); animation: pulse 1.6s infinite; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.08); } 100% { transform: scale(1); } }

    /* Profile modal for map (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á original) */
    #profileModal { position: absolute; right: 60px; top: 120px; z-index: 500; width: 420px; background: rgba(0,0,0,0.7); padding:20px; border-radius:12px; display:none; box-shadow: 0 10px 40px rgba(0,0,0,0.7); border:1px solid rgba(255,255,255,0.06); }
    .pf-row { display:flex; gap:12px; align-items:center; }
    .pf-avatar { width:86px; height:86px; border-radius:12px; background-size:cover; background-position:center; border:3px solid rgba(255,255,255,0.08); }
    .pf-info { flex:1; }
    .pf-name { font-size:1.2rem; font-weight:600; }
    .pf-bio { font-size:0.85rem; opacity:0.7; margin-top:6px; }
    .pf-start { margin-top:12px; display:flex; gap:10px; }
    .btn-start { flex:1; padding:12px 16px; border-radius:10px; border: none; cursor:pointer; font-weight:700; }
    .btn-start.play { background: linear-gradient(90deg,#ff2d55,#3b5998); color:#fff; }
    .btn-start.info { background: rgba(255,255,255,0.06); color:#fff; border:1px solid rgba(255,255,255,0.08); }

    /* Modern Call UI (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°) */
    #call-overlay { 
        position: absolute; inset: 0; background: rgba(0,0,0,0.45); 
        backdrop-filter: blur(8px); display: none; flex-direction: column; 
        align-items: center; justify-content: center; z-index: 2000; padding: 40px;
    }
    .call-card { width:340px; background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); border-radius:18px; padding:22px; display:flex; flex-direction:column; gap:14px; align-items:center; box-shadow: 0 12px 40px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.06); }
    .call-pfp { width:120px; height:120px; border-radius:50%; border: 3px solid rgba(255,255,255,0.06); background: url('‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠.jpg') center/cover; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .call-name { font-weight:600; font-size:1.1rem; }
    .call-sub { opacity:0.6; font-size:0.85rem; }
    .call-actions { display:flex; gap:18px; margin-top:6px; }
    .c-btn { width:64px; height:64px; border-radius:50%; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:1.6rem; color: white; transition: 0.2s; }
    .c-btn.accept { background: #4cd964; box-shadow: 0 8px 30px rgba(76,217,100,0.28); }
    .c-btn.decline { background: #ff3b30; box-shadow: 0 8px 30px rgba(255,59,48,0.25); }

    /* Video Screen */
    #video-screen { background: #000; justify-content:center; align-items:center; }
    video { width: 100%; height: 100%; object-fit: cover; }

    /* Choice Box */
    .choice-box { position: absolute; bottom: 80px; right: 80px; background: rgba(0,0,0,0.85); padding: 28px; border-radius: 10px; display: flex; flex-direction: column; gap: 12px; width: 420px; border-left: 5px solid var(--primary); }
    .btn-c { background: none; border: 1px solid #fff; color: #fff; padding: 12px; cursor: pointer; transition: 0.3s; text-align: left; font-size: 1rem; border-radius: 6px; }
    .btn-c:hover { background: #fff; color: #000; }

    /* Chat UI */
    #chat-screen { background: linear-gradient(180deg,#0f1724,#123a5a); }
    .chat-scroll { flex: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; padding-top: 100px; padding-bottom: 120px; }
    .bubble { padding: 12px 18px; border-radius: 15px; color: #000; max-width: 70%; line-height: 1.4; position: relative; }
    .bubble.him { background: #fff; align-self: flex-start; border-top-left-radius: 2px; }
    .bubble.me { background: var(--line-green); align-self: flex-end; border-top-right-radius: 2px; }
    .chat-opts { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: none; flex-direction: column; gap: 10px; width: 90%; max-width: 420px; z-index: 500; }
    .opt-card { background: #fff; color: #000; padding: 12px; border-radius: 10px; text-align: center; cursor: pointer; font-weight: 600; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

    /* Narration */
    .narration { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 8000; display: none; justify-content: center; align-items: center; text-align: center; padding: 40px; font-size: 1.1rem; font-weight: 300; }

    /* IG Post UI */
    #ig-screen { display:none; justify-content:center; align-items:center; background: #fafafa; color:#111; }
    .ig-card { width:640px; background:#fff; border-radius:12px; box-shadow: 0 10px 50px rgba(0,0,0,0.15); overflow:hidden; }
    .ig-header { padding:12px; display:flex; gap:10px; align-items:center; }
    .ig-avatar { width:44px; height:44px; border-radius:50%; background:url('‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏î‡∏≥.jpg') center/cover; }
    .ig-username { font-weight:700; }
    .ig-image { width:100%; height:480px; background:url('‡∏î‡∏≥.jpg') center/cover; background-size:cover; }
    .ig-caption { padding:12px; }
    .ig-actions { padding:12px; display:flex; gap:10px; }

    /* Result */
    #result-screen { justify-content:center; align-items:center; display:none; }
    .result-card { background:#111; padding:30px; border-radius:12px; border:1px solid #333; text-align:center; }

    /* Dam overlay choices */
    #damOverlay { position: absolute; inset: 0; display:none; align-items:center; justify-content:center; z-index:9000; background: rgba(0,0,0,0.6); }
    .dam-card { width:520px; background: rgba(0,0,0,0.85); padding:20px; border-radius:12px; border:1px solid rgba(255,255,255,0.06); }
    .dam-card img { width:100%; border-radius:8px; }
    .dam-opts { display:flex; gap:12px; margin-top:12px; }

    /* minor responsiveness */
    @media (max-width:900px){ .ig-card{width:92vw;} #profileModal{right:20px; top:90px; width:300px;} }
</style>

</head>
<body><div id="fadeLayer"></div>
<div class="narration" id="narrationBox"></div>

<div id="timeline">
    <div class="tl-step active" id="tl-1">DAY 01 - ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
    <div class="tl-step" id="tl-2">DAY 02 - ‡πÇ‡∏î‡∏°</div>
</div>

<div id="globalStatus">
    <div class="day-box" id="dayDisplay">DAY 01</div>
    <div style="letter-spacing: 2px; font-weight: 200; border-left: 1px solid rgba(255,255,255,0.3); padding-left: 15px;">MORNING</div>
</div>

<audio id="sndBgm" src="https://www.chosic.com/wp-content/uploads/2021/04/Rainy-Day.mp3" loop></audio>
<audio id="sndMsg" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>
<audio id="sndCall" src="https://assets.mixkit.co/active_storage/sfx/1350/1350-preview.mp3" loop></audio>

<div id="lobby" class="screen active"><button class="play-btn" onclick="startApp()">PLAY</button></div>

<div id="map-screen" class="screen">
    <div id="marker-b1" class="map-marker" style="top:51%; left:43%;" onclick="openProfile('‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠','‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠.jpg','‡∏Ñ‡∏ô‡∏ä‡∏≠‡∏ö‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡∏∞‡∏ä‡∏≠‡∏ö‡∏ï‡∏•‡∏Å', startIntroVideo)">B1</div>
    <div id="marker-dome" class="map-marker" style="top:70%; left:48%; display:none;" onclick="openProfile('‡πÇ‡∏î‡∏°','‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏î‡∏°.jpg','‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡∏ó‡∏µ‡πà‡πÇ‡∏î‡∏°', startDomeEvent)">D</div>

    <!-- Profile modal shown when clicking a marker -->
    <div id="profileModal">
        <div class="pf-row">
            <div class="pf-avatar" id="pfAvatar" style="background-image:url('‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠.jpg')"></div>
            <div class="pf-info">
                <div class="pf-name" id="pfName">‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠</div>
                <div class="pf-bio" id="pfBio">mobile</div>
                <div class="pf-start">
                    <button class="btn-start play" id="pfStartBtn">START</button>
                    <button class="btn-start info" onclick="closeProfile()">CANCEL</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="video-screen" class="screen">
    <video id="vPlayer" playsinline></video>
    <div id="call-overlay">
        <div class="call-card">
            <div class="call-pfp"></div>
            <div class="call-name">‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠</div>
            <div class="call-sub">mobile</div>
            <div class="call-actions">
                <button class="c-btn decline" onclick="declineCall()">‚úï</button>
                <button class="c-btn accept" onclick="acceptCall()">üì±</button>
            </div>
        </div>
    </div>
</div>

<div id="choice-screen" class="screen" style="background-image: url('‡∏†‡∏≤‡∏û‡∏ô‡∏¥‡πà‡∏á‡∏â‡∏≤‡∏Å‡πÅ‡∏£‡∏Å‡∏ï‡∏≠‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å.jpg');">
    <div class="choice-box">
        <button class="btn-c" onclick="goTo('chat-screen', runChatDay1)">üì± ‡∏ó‡∏±‡∏Å LINE ‡πÑ‡∏õ‡∏à‡∏µ‡∏ö</button>
        <button class="btn-c" style="color:var(--primary); border-color:var(--primary);" onclick="playPrison()">üëä ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏Å‡∏£‡∏∞‡∏ó‡∏∑‡∏ö‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠</button>
    </div>
</div>

<div id="chat-screen" class="screen">
    <div style="position:fixed; top:0; width:100%; background:#2c3e50; padding:40px 0 10px; text-align:center; z-index:100;">‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠</div>
    <div class="chat-scroll" id="chatBox"></div>
    <div id="chatSelect" class="chat-opts"></div>
</div>

<div id="ig-screen" class="screen">
    <div style="flex:1; display:flex; justify-content:center; align-items:center; padding:30px;">
        <div class="ig-card">
            <div class="ig-header">
                <div class="ig-avatar"></div>
                <div>
                    <div class="ig-username">dammaybe</div>
                    <div style="opacity:0.6; font-size:0.9rem;">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
                </div>
            </div>
            <div class="ig-image"></div>
            <div class="ig-caption">‡∏î‡∏≥‡∏à‡∏±‡∏á ‡πÅ‡∏ï‡πà‡∏Å‡πá‡∏´‡∏•‡πà‡∏≠</div>
            <div class="ig-actions">
                <button class="btn-c" style="background:#111; color:#fff;" onclick="openDM()">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
                <button class="btn-c" onclick="goTo('map-screen')">‡∏Å‡∏•‡∏±‡∏ö</button>
            </div>
        </div>
    </div>
</div>

<div id="result-screen" class="screen" style="justify-content:center; align-items:center;">
    <div class="result-card" id="resultCard">
        <h1 style="color:var(--primary);" id="resultTitle">DAY CLEAR</h1>
        <div id="resultBody" style="margin-top:12px;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</div>
        <div style="margin-top:16px;"><button class="btn-c" style="width:200px;" onclick="location.reload()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button></div>
    </div>
</div>

<!-- Dam overlay (‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ ‡πÑ‡∏≠‡πâ‡∏î‡∏≥mp.4 ‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏ä‡∏ß‡πå‡∏†‡∏≤‡∏û‡∏Ñ‡πâ‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πâ‡∏≠‡∏¢‡∏™‡πå) -->
<div id="damOverlay">
    <div class="dam-card">
        <img src="‡∏î‡∏≥.jpg" alt="‡∏î‡∏≥">
        <div class="dam-opts">
            <button class="btn-c" onclick="chooseDamIG()">1. ‡∏Ç‡∏≠‡πÑ‡∏≠‡∏à‡∏µ‡∏à‡∏≤‡∏Å‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠</button>
            <button class="btn-c" onclick="chooseDamIgnore()">2. ‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à ‡∏î‡∏≥‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏≤‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤</button>
        </div>
    </div>
</div>

<script>
    // --- State ---
    const v = document.getElementById('vPlayer');
    const f = document.getElementById('fadeLayer');
    const nar = document.getElementById('narrationBox');
    const bgm = document.getElementById('sndBgm');
    const callSnd = document.getElementById('sndCall');
    const msgSnd = document.getElementById('sndMsg');

    // relationship values (out of arbitrary scale)
    const rel = { lomneua: 85, dam: 0 };

    function startApp(){
        // user clicked PLAY - ok to play audio
        bgm.play().catch(()=>{});
        goTo('map-screen');
    }

    function goTo(id, callback){
        f.style.opacity = '1';
        setTimeout(() => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            // timeline highlight
            document.querySelectorAll('.tl-step').forEach(t=>t.classList.remove('active'));
            if(id === 'map-screen') document.getElementById('tl-1').classList.add('active');
            if(id === 'ig-screen') document.getElementById('tl-2').classList.add('active');
            document.getElementById('globalStatus').style.display = (id === 'map-screen') ? 'flex' : 'none';
            if(callback) callback();
            f.style.opacity = '0';
        }, 500);
    }

    // --- Profile modal logic on map markers ---
    function openProfile(name, avatar, bio, onStart){
        document.getElementById('pfName').innerText = name;
        document.getElementById('pfBio').innerText = bio || '';
        document.getElementById('pfAvatar').style.backgroundImage = `url('${avatar}')`;
        document.getElementById('pfStartBtn').onclick = () => { closeProfile(); if(onStart) onStart(); };
        document.getElementById('profileModal').style.display = 'block';
    }
    function closeProfile(){ document.getElementById('profileModal').style.display = 'none'; }

    // --- Videos / flow ---
    function startIntroVideo(){
        goTo('video-screen', () => {
            v.src = "‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏£‡∏ß‡∏°‡∏≠‡∏¥‡∏ô‡πÇ‡∏ó‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°.mp4";
            v.load(); v.play();
            v.onended = () => goTo('choice-screen');
        });
    }

    function playPrison(){
        goTo('video-screen', () => {
            v.src = "‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ó‡∏∑‡∏ö.mp4"; v.load(); v.play();
            v.onended = () => { alert("‡∏ï‡∏¥‡∏î‡∏Ñ‡∏∏‡∏Å‡∏Ñ‡πà‡∏∞! ‡∏´‡πâ‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ô‡∏∞‡∏Ñ‡∏∞"); location.reload(); };
        });
    }

    // --- Chat system (day1) ---
    async function runChatDay1(){
        const box = document.getElementById('chatBox'); box.innerHTML = '';
        await addMsg('me','‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞ ‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏Ñ‡∏∞?');
        await addMsg('him','‡πÉ‡∏ä‡πà‡∏Ñ‡∏£‡∏±‡∏ö ‡πÉ‡∏Ñ‡∏£‡πÄ‡∏´‡∏£‡∏≠ ‡∏ó‡∏±‡∏Å‡∏°‡∏≤‡∏ñ‡∏π‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏à‡∏±‡∏á');
        await addMsg('me','‡∏´‡∏¢‡∏Å‡πÄ‡∏≠‡∏á‡∏Ñ‡πà‡∏∞ ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏≠‡∏ö‡∏°‡∏≠‡∏á‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ 1 ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏µ‡πâ‡πÑ‡∏á');
        await addMsg('him','‡∏≠‡πã‡∏≠‡∏≠‡∏≠ ‡∏´‡∏¢‡∏Å‡∏ô‡∏µ‡πà‡πÄ‡∏≠‡∏á ‡∏ô‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏Å‡∏°‡∏≤‡∏ã‡∏∞‡πÅ‡∏•‡πâ‡∏ß');
        showChatOptions([
            { t: '"‡∏Å‡πá‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡∏ô‡∏±‡πâ‡∏ô ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏Å‡πÑ‡∏î‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏á‡∏•‡πà‡∏∞‡∏Ñ‡∏∞"', next: 1 },
            { t: '"‡∏´‡∏¢‡∏Å‡∏≠‡∏¢‡∏≤‡∏Å‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏±‡∏á"', next: 2 }
        ]);
    }

    function showChatOptions(opts){
        const ui = document.getElementById('chatSelect'); ui.innerHTML = '';
        opts.forEach(o=>{
            const b = document.createElement('div'); b.className='opt-card'; b.innerText=o.t;
            b.onclick = async ()=>{ ui.style.display='none'; await addMsg('me', o.t); handleChatChoice(o); };
            ui.appendChild(b);
        });
        ui.style.display='flex';
    }

    async function handleChatChoice(opt){
        // logic for day1 chat
        if(opt.next === 1){
            await addMsg('him','‡∏û‡∏π‡∏î‡∏ï‡∏£‡∏á‡πÑ‡∏õ‡∏°‡∏±‡πâ‡∏¢‡πÄ‡∏ô‡∏µ‡πà‡∏¢... ‡∏ú‡∏°‡πÄ‡∏Ç‡∏¥‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞');
            await addMsg('him','‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏°‡∏≤‡∏´‡∏≤‡∏ú‡∏°‡∏≠‡∏µ‡∏Å‡∏°‡∏±‡πâ‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö?');
            showChatOptions([
                { t: '"‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏´‡∏≤ ‡∏´‡∏¢‡∏Å‡∏Å‡πá‡∏à‡∏∞‡πÑ‡∏õ‡∏´‡∏≤‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞"', next: 3 },
                { t: '"‡∏Ç‡∏≠‡∏î‡∏π‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏à‡∏∞‡πÉ‡∏à‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡∏´‡∏¢‡∏Å‡∏°‡∏±‡πâ‡∏¢"', next: 3 }
            ]);
        } else if(opt.next === 2){
            await addMsg('him','‡∏≠‡∏¢‡∏≤‡∏Å‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô‡∏•‡πà‡∏∞‡∏Ñ‡∏∞?');
            await addMsg('me','‡∏≠‡∏¢‡∏≤‡∏Å‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏ñ‡∏∂‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏ô‡∏à‡∏π‡∏á‡∏°‡∏∑‡∏≠‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞');
            await addMsg('him','‡πÅ‡∏£‡∏á‡∏ô‡∏∞‡πÄ‡∏£‡∏≤‡∏ô‡πà‡∏∞... ‡∏á‡∏±‡πâ‡∏ô‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏•‡∏≠‡∏á‡∏°‡∏≤‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°‡∏™‡∏¥');
            setTimeout(()=> goTo('result-screen', ()=> showResultCard('DAY 1 CLEAR','‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠: '+rel.lomneua+'%')) , 1200);
        } else if(opt.next === 3){
            await addMsg('him','‡∏õ‡∏≤‡∏Å‡∏´‡∏ß‡∏≤‡∏ô‡∏à‡∏±‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞... ‡∏á‡∏±‡πâ‡∏ô‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏à‡∏≠‡∏Å‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°‡∏ô‡∏∞');
            setTimeout(()=> goTo('result-screen', ()=> showResultCard('DAY 1 CLEAR','‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠: '+rel.lomneua+'%')) , 1200);
        }
    }

    async function addMsg(side, text){
        const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent = side === 'me' ? 'flex-end' : 'flex-start';
        let html = side === 'him' ? `<div style="width:40px; height:40px; border-radius:50%; background:url('‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠.jpg') center/cover; margin-right:10px;"></div>` : '';
        html += `<div class="bubble ${side}">${text}</div>`;
        row.innerHTML = html; document.getElementById('chatBox').appendChild(row);
        msgSnd.currentTime=0; msgSnd.play().catch(()=>{});
        document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
        await new Promise(r=>setTimeout(r,1200));
    }

    // --- Day 2 & Call ---
    function startDay2(){
        showNarration("‡πÄ‡∏ä‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ï‡πà‡∏≠‡∏°‡∏≤...", ()=>{
            document.getElementById('dayDisplay').innerText = 'DAY 02';
            document.getElementById('marker-b1').style.display='none';
            document.getElementById('marker-dome').style.display='block';
            document.getElementById('tl-1').classList.remove('active');
            document.getElementById('tl-2').classList.add('active');
            goTo('video-screen', ()=>{
                v.src = "‡∏ö‡πâ‡∏≤‡∏ô‡∏ú‡∏°1.mp4"; v.load(); v.play();
                v.onended = ()=>{ v.pause(); document.getElementById('call-overlay').style.display='flex'; callSnd.play().catch(()=>{}); };
            });
        });
    }

    function acceptCall(){
        callSnd.pause(); document.getElementById('call-overlay').style.display='none';
        // show simple call options as chat choices
        showChatOptions([
            { t: '"‡∏Æ‡∏±‡∏•‡πÇ‡∏´‡∏•‡∏Ñ‡πà‡∏∞... ‡πÇ‡∏ó‡∏£‡∏°‡∏≤‡∏õ‡∏•‡∏∏‡∏Å‡∏´‡∏¢‡∏Å‡πÄ‡∏´‡∏£‡∏≠‡∏Ñ‡∏∞?"', next: 'call1' },
            { t: '"‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏ô‡∏∞‡∏Ñ‡∏∞‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ ‡∏´‡∏¢‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏ï‡∏∑‡πà‡∏ô‡πÄ‡∏≠‡∏á!"', next: 'call2' }
        ]);
    }
    function declineCall(){ callSnd.pause(); document.getElementById('call-overlay').style.display='none'; }

    async function handleChatChoice_call(opt){ /* kept for backward compat if needed */ }

    // unified handler for call options inside handleChatChoice
    // but opt.next can be 'call1' or 'call2'
    async function handleChatChoice(opt){
        if(opt.next === 'call1' || opt.next === 'call2'){
            let reply = opt.next === 'call1' ? "‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠: ‡πÉ‡∏ä‡πà‡∏Ñ‡πà‡∏∞ ‡πÇ‡∏ó‡∏£‡∏°‡∏≤‡∏õ‡∏•‡∏∏‡∏Å‡∏ô‡∏±‡πà‡∏ô‡πÅ‡∏´‡∏•‡∏∞ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏°‡∏≤‡∏ô‡∏±‡∏î‡πÄ‡∏£‡∏≤‡∏™‡∏≤‡∏¢‡∏ô‡∏∞!" : "‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠: ‡∏ï‡∏∑‡πà‡∏ô‡∏™‡∏≤‡∏¢‡∏ô‡∏∞‡πÄ‡∏£‡∏≤ 555 ‡∏£‡∏µ‡∏ö‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞";
            showNarration(reply, ()=>{
                // after that narration, new narration to say mover to dome and then place marker
                showNarration("‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠: ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÇ‡∏î‡∏°‡∏ô‡∏∞ ‡∏°‡∏≤‡∏´‡∏≤‡πÄ‡∏£‡∏≤‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‡∏°‡∏µ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏∞‡∏ñ‡∏≤‡∏°‡∏Ñ‡πà‡∏∞", ()=>{
                    document.getElementById('dayDisplay').innerText = 'DAY 02';
                    document.getElementById('marker-b1').style.display = 'none';
                    document.getElementById('marker-dome').style.display = 'block';
                    goTo('map-screen');
                });
            });
            return;
        }
        // else keep original chat logic
        // handled earlier by the other handleChatChoice (day1)
    }

    // --- Dome Event flow (‡∏õ‡∏£‡∏±‡∏ö) ---
    function startDomeEvent(){
        goTo('video-screen', ()=>{
            // first play ‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ñ‡∏≤‡∏°
            v.src = "‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ñ‡∏≤‡∏°.mp4"; v.load(); v.play();
            v.onended = ()=>{
                // then play ‡πÑ‡∏≠‡πâ‡∏î‡∏≥mp.4
                v.src = "‡πÑ‡∏≠‡πâ‡∏î‡∏≥mp.4"; v.load(); v.play();
                v.onended = ()=>{
                    // show image freeze with choices
                    document.getElementById('damOverlay').style.display='flex';
                };
            };
        });
    }

    function chooseDamIgnore(){
        // game over path - according to user: "‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏°‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏≠‡πà‡∏≠‡∏ô ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏≠‡∏≤‡∏î‡∏≥"
        document.getElementById('damOverlay').style.display='none';
        showNarration('‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡πÑ‡∏≠‡∏à‡∏µ‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏≤ ‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏°‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏≠‡πà‡∏≠‡∏ô ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏≠‡∏≤‡∏î‡∏≥', ()=>{
            // penalty to lomneua and show game over
            rel.lomneua = Math.max(0, rel.lomneua - 30);
            showResultCard('GAME OVER','‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏≠‡∏≤‡∏î‡∏≥<br>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠: '+rel.lomneua+'%');
            goTo('result-screen');
        });
    }

    function chooseDamIG(){
        document.getElementById('damOverlay').style.display='none';
        // user got IG -> update relations
        rel.dam = Math.min(100, rel.dam + 40);
        rel.lomneua = Math.min(100, rel.lomneua + 5); // small boost
        // open IG UI so user can "‡∏™‡πà‡∏≠‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå" ‡πÅ‡∏•‡∏∞ DM
        showNarration('‡πÑ‡∏î‡πâ‡πÑ‡∏≠‡∏à‡∏µ‡πÅ‡∏•‡πâ‡∏ß! ‡πÑ‡∏õ‡∏™‡πà‡∏≠‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏î‡∏≥‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞', ()=>{
            goTo('ig-screen');
        });
    }

    // IG -> DM flow
    async function openDM(){
        // simulate DM chat with ‡∏î‡∏≥
        goTo('chat-screen', async ()=>{
            const box = document.getElementById('chatBox'); box.innerHTML='';
            await addMsg('him','‡πÄ‡∏Æ‡πâ‡∏¢ ‡πÉ‡∏Ñ‡∏£‡πÄ‡∏ô‡∏µ‡πà‡∏¢‡∏°‡∏≤‡∏™‡πà‡∏≠‡∏á?');
            await addMsg('me','‡∏´‡∏¢‡∏Å‡πÄ‡∏≠‡∏á‡∏Ñ‡πà‡∏∞ ‡πÄ‡∏´‡πá‡∏ô‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏°‡∏≤‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ');
            await addMsg('him','‡πÇ‡∏≠‡πä‡∏∞ ‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏à‡∏±‡∏á ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏´‡∏°‡∏à‡∏∞‡∏ä‡∏ß‡∏ô‡πÑ‡∏õ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≤‡πÅ‡∏ü');
            await addMsg('me','‡πÑ‡∏õ‡∏™‡∏¥‡∏Ñ‡∏∞ ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏™‡∏¥');
            await addMsg('him','‡πÇ‡∏≠‡πÄ‡∏Ñ ‡∏ô‡∏±‡∏î‡∏Ñ‡∏∑‡∏ô‡∏ô‡∏µ‡πâ‡∏ô‡∏∞');
            // end of DM -> give day2 result
            setTimeout(()=>{
                showResultCard('DAY 02 CLEAR','‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå (raw): ‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠='+rel.lomneua+', ‡∏î‡∏≥='+rel.dam);
                goTo('result-screen');
            },700);
        });
    }

    function showResultCard(title, bodyHtml){
        document.getElementById('resultTitle').innerText = title;
        // compute percent share between characters
        const total = (rel.lomneua + rel.dam) || 1;
        const pL = Math.round(rel.lomneua / total * 100);
        const pD = Math.round(rel.dam / total * 100);
        const body = `${bodyHtml}<br><br>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏£‡∏ß‡∏°: ‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ ${rel.lomneua} , ‡∏î‡∏≥ ${rel.dam}<br>‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏≠‡∏ö: ‡∏•‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ ${pL}% , ‡∏î‡∏≥ ${pD}%`;
        document.getElementById('resultBody').innerHTML = body;
    }

    function showNarration(txt, cb){
        nar.innerHTML = txt; nar.style.display = 'flex';
        setTimeout(()=>{ nar.style.display='none'; if(cb) cb(); }, 2200);
    }

    // small helper to start day2 from result button
    function startDay2FromResult(){ startDay2(); }

    // expose some functions to global scope for inline handlers
    window.startApp = startApp;
    window.goTo = goTo;
    window.openProfile = openProfile;
    window.closeProfile = closeProfile;
    window.startIntroVideo = startIntroVideo;
    window.playPrison = playPrison;
    window.runChatDay1 = runChatDay1;
    window.startDay2 = startDay2;
    window.acceptCall = acceptCall;
    window.declineCall = declineCall;
    window.startDomeEvent = startDomeEvent;
    window.chooseDamIG = chooseDamIG;
    window.chooseDamIgnore = chooseDamIgnore;
    window.openDM = openDM;

</script>

</body>
    </html>
